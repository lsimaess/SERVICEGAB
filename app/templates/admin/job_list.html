{% extends "base.html" %}
{% block title %}Tâches{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
  .card-wrapper {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
    padding: 2rem;
    margin-top: 2rem;
  }

  .btn i {
    margin-right: 0.4rem;
  }

  .table td, .table th {
    vertical-align: middle;
  }

  .badge {
    font-size: 0.85rem;
    font-weight: 600;
  }
</style>

<div class="container">
  <div class="card-wrapper">
    <h2 class="mb-4 text-primary">Liste des Tâches</h2>

    <div class="d-flex justify-content-between flex-wrap align-items-center mb-3">
      <a href="{{ url_for('admin.admin_job_create') }}" class="btn btn-primary mb-2">
        <i class="bi bi-plus-circle"></i> Créer une nouvelle tâche
      </a>
    </div>

    <!-- Filtres -->
    <form method="GET" class="row g-2 mb-4">
      <div class="col-md-2">
        <select name="status" class="form-select">
          <option value="">Statut</option>
          {% for value, label in [('PENDING', 'En attente'), ('ASSIGNED', 'Assignée'), ('COMPLETED', 'Terminée')] %}
            <option value="{{ value }}" {% if request_args.get('status') == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <select name="requester_id" class="form-select">
          <option value="">Demandeur</option>
          {% for r in requesters %}
            <option value="{{ r.id }}" {% if request_args.get('requester_id') == r.id|string %}selected{% endif %}>{{ r.full_name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <select name="worker_id" class="form-select">
          <option value="">Travailleur</option>
          {% for w in workers %}
            <option value="{{ w.id }}" {% if request_args.get('worker_id') == w.id|string %}selected{% endif %}>{{ w.full_name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <select name="service_type_id" class="form-select">
          <option value="">Service</option>
          {% for s in services %}
            <option value="{{ s.id }}" {% if request_args.get('service_type_id') == s.id|string %}selected{% endif %}>{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <select name="zone" class="form-select">
          <option value="">Zone</option>
          {% for val, label in zones %}
            <option value="{{ val }}" {% if request_args.get('zone') == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <input type="date" name="date" value="{{ request_args.get('date', '') }}" class="form-control">
      </div>

      <div class="col-md-2">
        <select name="recurrence_type" class="form-select">
          <option value="">Tous</option>
          <option value="repeated" {% if request_args.get('recurrence_type') == 'repeated' %}selected{% endif %}>Récurrentes</option>
          <option value="children" {% if request_args.get('recurrence_type') == 'children' %}selected{% endif %}>Enfants</option>
          <option value="single" {% if request_args.get('recurrence_type') == 'single' %}selected{% endif %}>Simples</option>
        </select>
      </div>

      <div class="col-md-2 d-grid">
        <button type="submit" class="btn btn-outline-primary">
          <i class="bi bi-funnel"></i> Appliquer
        </button>
      </div>
    </form>

    <!-- Liste des Tâches -->
    {% if jobs %}
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Demandeur</th>
              <th>Travailleur</th>
              <th>Service</th>
              <th>Montant</th>
              <th>Zone</th>
              <th>Demandée</th>
              <th>Récurrence</th>
              <th>Parent</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for job in jobs %}
              <tr>
                <td>
                  {{ job.id }}
                  {% if job.repeated %}
                    <i class="bi bi-repeat text-info" title="Tâche récurrente"></i>
                  {% elif job.parent_job_id %}
                    <i class="bi bi-arrow-return-right text-secondary" title="Tâche enfant"></i>
                  {% endif %}
                </td>
                <td>{{ job.requester.full_name }}</td>
                <td>{{ job.worker.full_name if job.worker else "—" }}</td>
                <td>{{ job.service_needed.name }}</td>
                <td>{{ "{:,.0f}".format(job.payment_amount or 0) }} FCFA</td>
                <td>{{ job.zone or "—" }}</td>
                <td>{{ job.date_needed.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>{{ job.recurrence_pattern or "—" }}</td>
                <td>{{ job.parent_job_id or "—" }}</td>
                <td>
                  <span class="badge bg-{{ 'secondary' if job.status == 'PENDING' else 'info' if job.status == 'ASSIGNED' else 'success' }}">
                    {{ job.status.capitalize() }}
                  </span>
                </td>
                <td class="text-nowrap">
                  <a href="{{ url_for('admin.admin_job_detail', id=job.id) }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i>
                  </a>
                  {% if job.status == 'ASSIGNED' %}
                    <a href="{{ url_for('admin.admin_job_complete', id=job.id) }}" class="btn btn-sm btn-outline-success">
                      <i class="bi bi-check-circle"></i>
                    </a>
                  {% endif %}
                  <form method="POST" action="{{ url_for('admin.admin_job_delete', id=job.id) }}" class="d-inline-block" onsubmit="return confirm('Supprimer cette tâche ?');">
                    <button class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">Aucune tâche trouvée.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
